

==================================================
# ÙØ§ÛŒÙ„: .env
==================================================

DB_HOST=localhost
DB_USER=root
DB_PASSWORD=yourpassword
DB_NAME=print3d

==================================================
# ÙØ§ÛŒÙ„: config.py
==================================================

import os


class Config:
    # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    DB_HOST = '127.0.0.1'
    DB_PORT =3308  # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯
    DB_USER ='testuser'
    DB_PASS = 'testpass'
    DB_NAME ='print3d'

    # ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…
    TG_TOKEN = os.getenv("TG_TOKEN", "YOUR_BOT_TOKEN")

    # Ù„ÛŒØ³Øª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ (Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ)
    ADMINS = [2138687434]  # Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ Ø¨Ø§ Ø¢ÛŒØ¯ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø¯Ù…ÛŒÙ†

    # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±ÙØ±Ø§Ù„
    REFERRAL_CODE_LENGTH = 10
    ADMIN_CODE_PREFIX = "ADMIN_"

==================================================
# ÙØ§ÛŒÙ„: database.py
==================================================

from sqlalchemy.exc import SQLAlchemyError
from sqlalchemy.orm import Session
from models import User, File, Referral, InvitedUser, Wallet, get_db, SessionLocal
from datetime import datetime, timedelta
import secrets
import string
import logging
from config import Config
from models import SessionLocal, User, Wallet

logger = logging.getLogger(__name__)

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡
ADMIN_ID = 2138687434

# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
# ----------------------
def get_db_connection():
    return mysql.connector.connect(
        host='localhost',
        port=3308,          # Ù¾ÙˆØ±ØªÛŒ Ú©Ù‡ Ø¯Ø± Docker ØªÙ†Ø¸ÛŒÙ… Ú©Ø±Ø¯ÛŒØ¯
        user='testuser',    # Ú©Ø§Ø±Ø¨Ø± ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø¯Ø± docker-compose.yml
        password='testpass', # Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ú©Ø§Ø±Ø¨Ø± testuser
        database='print3d',
        connect_timeout = 30
    )

def is_admin(user_id: int) -> bool:
    try:
        with SessionLocal() as db:
            user = db.query(User).get(user_id)
            return user.is_admin if user else False
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†: {str(e)}")
        return False

# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
# ----------------------
def generate_referral_code(is_admin: bool = False) -> str:
    prefix = "ADMIN_" if is_admin else ""
    suffix = ''.join(secrets.choice(string.ascii_uppercase + string.digits) for _ in range(10))
    return f"{prefix}{suffix}"



# ----------------------
# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ (Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ MySQL)
# ----------------------



# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
# ----------------------
def add_user(user_data: dict) -> bool:
    try:
        with SessionLocal() as db:
            new_user = User(
                id=user_data['id'],
                full_name=user_data['full_name'],
                phone=user_data.get('phone', 'Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡'),
                inviter_id=user_data.get('inviter_id'),
                is_admin=user_data.get('is_admin', False)
            )

            if new_user.is_admin:
                wallet = Wallet(user_id=new_user.id)
                db.add(wallet)

            db.add(new_user)
            db.commit()
            return True
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ú©Ø§Ø±Ø¨Ø±: {str(e)}")
        return False


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ø±ÙØ±Ø§Ù„
# ----------------------
# ==============================
# â–ˆâ–ˆâ–ˆ CREATING REFERRAL CODE â–ˆâ–ˆâ–ˆ
# ==============================
from mysql.connector import IntegrityError

def create_referral(db: Session, user_id: int, is_admin: bool = False) -> str:
    while True:
        code = generate_referral_code(is_admin)
        existing = db.query(Referral).filter(Referral.referral_code == code).first()
        if not existing:
            referral = Referral(
                referrer_id=user_id,
                referral_code=code,
                is_admin=is_admin,
                expires_at=datetime.now() + timedelta(days=365)
            )
            db.add(referral)
            db.commit()
            return code

# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø±ÙØ±Ø§Ù„
# ----------------------
def validate_referral(db: Session, code: str):
    try:
        referral = db.query(Referral).filter(
            Referral.referral_code == code,
            Referral.is_active == True,
            Referral.used_count < Referral.max_uses,
            Referral.expires_at > datetime.now()
        ).first()

        if not referral:
            return False, "Ú©Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡"

        # Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡
        referral.used_count += 1
        if referral.used_count >= referral.max_uses:
            referral.is_active = False

        # Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¹ØªØ¨Ø§Ø±
        referrer = db.query(User).get(referral.referrer_id)
        referrer.total_earned += 50  # 50 Ø¯Ù„Ø§Ø± Ø¬Ø§ÛŒØ²Ù‡
        db.commit()

        return True, referral.referrer_id

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ: {str(e)}")
        return False, "Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ"


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¯Ø¹ÙˆÛŒÙ†
# ----------------------
def add_invited_user(referrer_id, user_data):
    """Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø¹ÙˆØª Ø´Ø¯Ù‡ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±Ø§Ú©Ù†Ø´"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()

        # ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¨Ù‡ ÙØ±Ù…Øª Ù…Ù†Ø§Ø³Ø¨ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        invited_at = datetime.now()
        full_data = (
            referrer_id,
            user_data[0],  # invited_user_id
            user_data[1],  # invited_full_name
            user_data[2],  # invited_phone
            invited_at
        )

        cursor.execute('''
            INSERT INTO invited_users 
            (referrer_id, invited_user_id, invited_full_name, invited_phone, invited_at)
            VALUES (%s, %s, %s, %s, %s)
        ''', full_data)

        conn.commit()
        logger.info(f"Ú©Ø§Ø±Ø¨Ø± Ø¯Ø¹ÙˆØª Ø´Ø¯Ù‡ {user_data[0]} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯")
        return True

    except mysql.connector.IntegrityError as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ ÛŒÚ©ØªØ§ÛŒÛŒ Ø¯Ø± Ø«Ø¨Øª Ù…Ø¯Ø¹Ùˆ: {e}")
        return False
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ø¯Ø¹Ùˆ: {e}", exc_info=True)
        if conn:
            conn.rollback()
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def mark_referral_used(code, used_by):
    """Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ú©Ø¯ Ø¯Ø¹ÙˆØª Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()

        cursor.execute('''
            UPDATE referrals 
            SET used_by = %s 
            WHERE referral_code = %s
        ''', (used_by, code))

        conn.commit()
        logger.info(f"Ú©Ø¯ Ø¯Ø¹ÙˆØª {code} ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± {used_by} Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯")
        return cursor.rowcount > 0

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±ÙØ±Ø§Ù„: {e}")
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def get_invited_users(referrer_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù…Ø¯Ø¹ÙˆÛŒÙ† Ø¨Ø§ ÙØ±Ù…Øª Ù…Ù†Ø¸Ù…"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)

        cursor.execute('''
            SELECT 
                invited_full_name AS name,
                invited_phone AS phone,
                DATE_FORMAT(invited_at, '%%Y/%%m/%%d %%H:%%i') AS date
            FROM invited_users 
            WHERE referrer_id = %s
            ORDER BY invited_at DESC
        ''', (referrer_id,))

        return cursor.fetchall()

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ø¹ÙˆÛŒÙ†: {e}")
        return []
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def decrement_invites(user_id):
    """Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()

        cursor.execute('''
            UPDATE users 
            SET remaining_invites = GREATEST(remaining_invites - 1, 0)
            WHERE id = %s
        ''', (user_id,))

        conn.commit()
        logger.debug(f"ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØª")
        return cursor.rowcount > 0

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ú©Ø§Ù‡Ø´ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§: {e}")
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (ØªÚ©Ù…ÛŒÙ„ÛŒ)
# ----------------------
def add_user(user_data: dict) -> bool:
    try:
        with SessionLocal() as db:
            new_user = User(**user_data)
            db.add(new_user)

            # Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
            wallet = Wallet(user_id=user_data['id'])
            db.add(wallet)

            db.commit()
            return True
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±: {str(e)}")
        db.rollback()
        return False


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
# ----------------------
def get_active_orders(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª ÙØ¹Ø§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ ÙØ±Ù…Øª Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)

        cursor.execute("""
            SELECT 
                id,
                file_name,
                quantity,
                status,
                created_at
            FROM files 
            WHERE user_id = %s 
                AND status = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…'
            ORDER BY created_at DESC
        """, (user_id,))

        orders = []
        for order in cursor.fetchall():
            # ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¨Ù‡ ÙØ±Ù…Øª Ù‚Ø§Ø¨Ù„ Ø®ÙˆØ§Ù†Ø¯Ù†
            order['created_at'] = order['created_at'].strftime("%Y/%m/%d %H:%M")
            orders.append(order)

        return orders

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª: {e}")
        return []
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def get_active_orders_count(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª ÙØ¹Ø§Ù„ Ø¨Ø§ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©ÙˆØ¦Ø±ÛŒ"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT COUNT(id) 
            FROM files 
            WHERE user_id = %s 
                AND status = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…'
        """, (user_id,))

        return cursor.fetchone()[0] or 0

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø´Ù…Ø§Ø±Ø´ Ø³ÙØ§Ø±Ø´Ø§Øª: {e}")
        return 0
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def add_file(file_data):
    """Ø°Ø®ÛŒØ±Ù‡ Ø§Ù…Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±Ø§Ú©Ù†Ø´"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()

        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
        required_fields = [
            'user_id', 'file_name', 'mime_type',
            'file_id', 'file_unique_id', 'created_at'
        ]
        if len(file_data) < 6:
            raise ValueError("Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ Ù†Ø§Ù‚Øµ Ø§Ø³Øª")

        # Ø¯Ø±Ø¬ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯
        cursor.execute('''
            INSERT INTO files (
                user_id, file_name, mime_type,
                file_id, file_unique_id, created_at,
                quantity, description, status, notes
            ) VALUES (
                %s, %s, %s,
                %s, %s, %s,
                COALESCE(%s, 1),  # Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´ÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ ØªØ¹Ø¯Ø§Ø¯
                COALESCE(%s, 'ÙØ§Ù‚Ø¯ ØªÙˆØ¶ÛŒØ­Ø§Øª'),
                COALESCE(%s, 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…'),
                COALESCE(%s, '')
            )
        ''', file_data)

        conn.commit()
        logger.info(f"ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ ID {cursor.lastrowid} Ø«Ø¨Øª Ø´Ø¯")
        return True

    except mysql.connector.IntegrityError as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ ÛŒÚ©ØªØ§ÛŒÛŒ ÙØ§ÛŒÙ„: {e}")
        return False
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙØ§ÛŒÙ„: {e}", exc_info=True)
        if conn:
            conn.rollback()
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def get_files_by_user(user_id, days=None):
    """Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ ÙÛŒÙ„ØªØ± Ø²Ù…Ø§Ù†ÛŒ"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)

        query = """
            SELECT 
                id,
                file_name,
                quantity,
                status,
                created_at
            FROM files 
            WHERE user_id = %s
        """
        params = [user_id]

        if days and days > 0:
            query += " AND created_at >= DATE_SUB(NOW(), INTERVAL %s DAY)"
            params.append(days)

        query += " ORDER BY created_at DESC"

        cursor.execute(query, params)

        files = []
        for file in cursor.fetchall():
            file['created_at'] = file['created_at'].strftime("%Y/%m/%d")
            files.append(file)

        return files

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§: {e}")
        return []
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def update_file_description(file_id, description):
    """Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆØ¶ÛŒØ­Ø§Øª ÙØ§ÛŒÙ„ Ø¨Ø§ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ"""
    conn = None
    cursor = None
    try:
        if not description or len(description) > 500:
            raise ValueError("ØªÙˆØ¶ÛŒØ­Ø§Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±")

        conn = get_db_connection()
        cursor = conn.cursor()

        cursor.execute("""
            UPDATE files 
            SET description = %s 
            WHERE file_id = %s
        """, (description, file_id))

        conn.commit()
        logger.info(f"ØªÙˆØ¶ÛŒØ­Ø§Øª ÙØ§ÛŒÙ„ {file_id} Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯")
        return cursor.rowcount > 0

    except ValueError as e:
        logger.warning(f"Ø®Ø·Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ: {e}")
        return False
    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {e}")
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def get_file_quantity(file_id):
    """Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø¯Ø§Ø¯ ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT COALESCE(quantity, 1) 
            FROM files 
            WHERE file_id = %s
        """, (file_id,))

        result = cursor.fetchone()
        return result[0] if result else 1

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø¯Ø§Ø¯: {e}")
        return 1
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def update_file_quantity(file_id, new_qty):
    """Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…Ù‚Ø¯Ø§Ø± ÙˆØ±ÙˆØ¯ÛŒ"""
    conn = None
    cursor = None
    try:
        if not isinstance(new_qty, int) or new_qty < 1:
            raise ValueError("ØªØ¹Ø¯Ø§Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±")

        conn = get_db_connection()
        cursor = conn.cursor()

        cursor.execute("""
            UPDATE files 
            SET quantity = GREATEST(%s, 1) 
            WHERE file_id = %s
        """, (new_qty, file_id))

        conn.commit()
        logger.info(f"ØªØ¹Ø¯Ø§Ø¯ ÙØ§ÛŒÙ„ {file_id} Ø¨Ù‡ {new_qty} Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯")
        return cursor.rowcount > 0

    except ValueError as e:
        logger.warning(f"Ø®Ø·Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ¹Ø¯Ø§Ø¯: {e}")
        return False
    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯: {e}")
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def delete_file(file_id):
    """Ø­Ø°Ù Ø§Ù…Ù† ÙØ§ÛŒÙ„ Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø±Ú©ÙˆØ±Ø¯"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„ Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°Ù
        cursor.execute("SELECT id FROM files WHERE file_id = %s", (file_id,))
        if not cursor.fetchone():
            logger.warning(f"ÙØ§ÛŒÙ„ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ {file_id} ÛŒØ§ÙØª Ù†Ø´Ø¯")
            return False

        cursor.execute("DELETE FROM files WHERE file_id = %s", (file_id,))
        conn.commit()
        logger.info(f"ÙØ§ÛŒÙ„ {file_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯")
        return True

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø­Ø°Ù ÙØ§ÛŒÙ„: {e}")
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ Ùˆ Ù‡Ø¯Ø§ÛŒØ§
# ----------------------
def get_remaining_invites(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT COALESCE(remaining_invites, 0)
            FROM users 
            WHERE id = %s
        """, (user_id,))

        result = cursor.fetchone()
        return result[0] if result else 0

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§: {e}")
        return 0
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def add_discount(user_id, amount):
    """Ø§ÙØ²ÙˆØ¯Ù† ØªØ®ÙÛŒÙ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ"""
    conn = None
    cursor = None
    try:
        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…Ù‚Ø¯Ø§Ø± ØªØ®ÙÛŒÙ
        if not isinstance(amount, (int, float)) or amount <= 0:
            raise ValueError("Ù…Ù‚Ø¯Ø§Ø± ØªØ®ÙÛŒÙ Ù†Ø§Ù…Ø¹ØªØ¨Ø±")

        conn = get_db_connection()
        cursor = conn.cursor()

        cursor.execute("""
            UPDATE wallets 
            SET discount = discount + %s 
            WHERE user_id = %s
        """, (amount, user_id))

        conn.commit()
        logger.info(f"ØªØ®ÙÛŒÙ {amount} Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± {user_id} Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯")
        return cursor.rowcount > 0

    except ValueError as e:
        logger.warning(f"Ø®Ø·Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ: {e}")
        return False
    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: {e}")
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def meets_gift_conditions(db: Session, user_id: int) -> bool:
    try:
        # Ø´Ø±Ø§ÛŒØ· Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡:
        # 1. Ø­Ø¯Ø§Ù‚Ù„ 3 Ø³ÙØ§Ø±Ø´ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ø¯Ø± 3 Ù…Ø§Ù‡ Ú¯Ø°Ø´ØªÙ‡
        # 2. Ù…Ø¬Ù…ÙˆØ¹ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø­Ø¯Ø§Ù‚Ù„ 10 Ø¹Ø¯Ø¯
        three_months_ago = datetime.now() - timedelta(days=90)

        orders = db.query(File).filter(
            File.user_id == user_id,
            File.status == 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
            File.created_at >= three_months_ago
        ).all()

        total_completed = len(orders)
        total_quantity = sum(order.quantity for order in orders)

        return total_completed >= 3 and total_quantity >= 10

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ· Ù‡Ø¯ÛŒÙ‡: {str(e)}")
        return False


def get_completed_orders(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ø¨Ø§ ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)

        cursor.execute("""
            SELECT 
                id,
                file_name,
                quantity,
                DATE_FORMAT(created_at, '%%Y/%%m/%%d %%H:%%i') AS created_at,
                description
            FROM files 
            WHERE 
                user_id = %s 
                AND status = 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡'
            ORDER BY created_at DESC
        """, (user_id,))

        return cursor.fetchall()

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: {e}")
        return []
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ø¯Ø±Ø®Øª Ø¯Ø¹ÙˆØª
# ----------------------
def get_referral_tree(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)

        cursor.execute("""
            WITH RECURSIVE referral_tree AS (
                SELECT 
                    id,
                    full_name,
                    phone,
                    inviter_id,
                    0 AS level
                FROM users
                WHERE id = %s

                UNION ALL

                SELECT 
                    u.id,
                    u.full_name,
                    u.phone,
                    u.inviter_id,
                    rt.level + 1
                FROM users u
                INNER JOIN referral_tree rt ON u.inviter_id = rt.id
            )
            SELECT * FROM referral_tree
            ORDER BY level ASC
        """, (user_id,))

        return cursor.fetchall()

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: {e}")
        return []
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()


def format_referral_tree(tree_data):
    """Ù‚Ø§Ù„Ø¨â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø±Ø®Øª Ø¯Ø¹ÙˆØª Ø¨Ù‡ ØµÙˆØ±Øª Ù…ØªÙ† Ø³Ù„Ø³Ù„Ù‡ Ù…Ø±Ø§ØªØ¨ÛŒ"""
    try:
        tree = {}
        for item in tree_data:
            tree.setdefault(item['inviter_id'], []).append(item)

        def build_branch(parent_id, level=0):
            branch = []
            for child in tree.get(parent_id, []):
                prefix = "â”‚   " * (level - 1) + "â”œâ”€â”€ " if level > 0 else ""
                branch.append(f"{prefix}ğŸ‘¤ {child['full_name']} ({child['phone']})")
                branch.extend(build_branch(child['id'], level + 1))
            return branch

        return "\n".join(build_branch(None))

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ: {e}")
        return "Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®ØªØ§Ø±"

def add_purchase_commission(db: Session, user_id: int, amount: float):
    try:
        user = db.query(User).get(user_id)
        if user.inviter_id:
            referrer = db.query(User).get(user.inviter_id)
            commission = amount * 0.05  # 5% Ú©Ù…ÛŒØ³ÛŒÙˆÙ†
            referrer.total_earned += commission
            db.commit()
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ú©Ù…ÛŒØ³ÛŒÙˆÙ†: {str(e)}")


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¯Ø¹ÙˆÛŒÙ†
# ----------------------
def get_direct_invites(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù…Ø¯Ø¹ÙˆÛŒÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª"""
    conn = None
    cursor = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)

        cursor.execute("""
            SELECT 
                invited_full_name AS name,
                invited_phone AS phone,
                DATE_FORMAT(invited_at, '%%Y/%%m/%%d') AS date
            FROM invited_users 
            WHERE referrer_id = %s
            ORDER BY invited_at DESC
        """, (user_id,))

        return cursor.fetchall()

    except mysql.connector.Error as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: {e}")
        return []
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()
if __name__ == "__main__":
    create_tables()  # Ø§ÛŒÙ† Ø®Ø· Ø¨Ø§ÛŒØ¯ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯

==================================================
# ÙØ§ÛŒÙ„: docker-compose.yml
==================================================

services:
  mysql:
    image: mysql:8.0
    container_name: komak-mysql
    command:
      - --max_allowed_packet=256M
      - --wait_timeout=28800
      - --interactive_timeout=28800
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: print3d
      MYSQL_USER: testuser
      MYSQL_PASSWORD: testpass
    ports:
      - "3308:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: komak-phpmyadmin
    restart: always
    ports:
      - "8080:80"
    environment:
      PMA_HOST: mysql
      PMA_USER: testuser
      PMA_PASSWORD: testpass
      UPLOAD_LIMIT: 256M
    depends_on:
      - mysql

networks:
  default:
    name: komak_default


==================================================
# ÙØ§ÛŒÙ„: keyboards.py
==================================================

from telegram import (
    ReplyKeyboardMarkup,
    KeyboardButton,
    InlineKeyboardButton,
    InlineKeyboardMarkup
)
from telegram import ReplyKeyboardMarkup, KeyboardButton

import database

# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù¾Ø§ÛŒÙ‡ Ø¨Ø¯ÙˆÙ† Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯
# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
# ÙØ§ÛŒÙ„ keyboards.py
# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ†
admin_kb = ReplyKeyboardMarkup(
    [
        ["ğŸ”— ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯"],
        ["ğŸ‘¥ Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù†", "ğŸ“Š Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…"],
        ["ğŸŒ³ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®Øª Ø¯Ø¹ÙˆØª", "âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…"]
    ],
    resize_keyboard=True,
    is_persistent=True
)

customer_kb = ReplyKeyboardMarkup(
    [
        ["ğŸ“‚ Ø¢Ø±Ø´ÛŒÙˆ", "ğŸ”„ Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…"],
        ["ğŸ’³ Ú©ÛŒÙ Ù¾ÙˆÙ„", "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"],
        ["ğŸ“œ Ù‚ÙˆØ§Ù†ÛŒÙ†", "ğŸ§¾ ÙØ§Ú©ØªÙˆØ±"],
        ["ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡", "ğŸ‘¥ Ù…Ø¯Ø¹ÙˆÛŒÙ† Ù…Ù†"]
    ],
    resize_keyboard=True,
    is_persistent=True
)

archive_reply_kb = ReplyKeyboardMarkup(
    [
        ["ğŸ•’ Ù‡ÙØªÙ‡ Ø§Ø®ÛŒØ±", "ğŸ“… Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±"],
        ["ğŸ“‚ Ú©Ù„ Ø¢Ø±Ø´ÛŒÙˆ", "ğŸ”™ Ø¨Ø±Ú¯Ø´Øª"]
    ],
    resize_keyboard=True,
    is_persistent=True
)

# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
admin_kb = ReplyKeyboardMarkup(
    [
        ["ğŸ”— ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯"],
        ["ğŸ‘¥ Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù†", "ğŸ“Š Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…"],
        ["ğŸŒ³ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®Øª Ø¯Ø¹ÙˆØª", "âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…"]
    ],
    resize_keyboard=True
)

def get_qty_keyboard(current_qty=1):
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("-", callback_data="qty_down"),
            InlineKeyboardButton(str(current_qty), callback_data="noop"),
            InlineKeyboardButton("+", callback_data="qty_up")
        ],
        [
            InlineKeyboardButton("ØªØ£ÛŒÛŒØ¯ âœ…", callback_data="qty_confirm"),
            InlineKeyboardButton("Ù„ØºÙˆ â†©ï¸", callback_data="qty_cancel")
        ]
    ])

# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ú©ÛŒÙ Ù¾ÙˆÙ„
wallet_kb = ReplyKeyboardMarkup(
    [
        ["ğŸ’µ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ", "ğŸ« Ø§Ø¹ØªØ¨Ø§Ø± ØªØ®ÙÛŒÙ"],
        ["ğŸ”™ Ø¨Ø±Ú¯Ø´Øª"]
    ],
    resize_keyboard=True
)
#
# ÙØ§ÛŒÙ„: database.py
# ...

def get_customer_kb(user_id):
    """ØªÙ‡ÛŒÙ‡ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª ÙØ¹Ø§Ù„"""
    active_orders = database.get_active_orders_count(user_id)
    return ReplyKeyboardMarkup(
        keyboard=[
            ["ğŸ“‚ Ø¢Ø±Ø´ÛŒÙˆ", f"ğŸ”„ Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… ({active_orders})"],
            ["ğŸ’³ Ú©ÛŒÙ Ù¾ÙˆÙ„", "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"],
            ["ğŸ“œ Ù‚ÙˆØ§Ù†ÛŒÙ†", "ğŸ§¾ ÙØ§Ú©ØªÙˆØ±"],
            ["ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡", "ğŸ‘¥ Ù…Ø¯Ø¹ÙˆÛŒÙ† Ù…Ù†"]  # Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¬Ø¯ÛŒØ¯
        ],
        resize_keyboard=True,
        is_persistent=True
    )

==================================================
# ÙØ§ÛŒÙ„: main.py
==================================================

import logging
from telegram.ext import Application, CommandHandler, MessageHandler, filters
from handlers.user_handlers import start
from config import Config
from models import Base, engine

from telegram.ext import Application as TgApplication

from telegram.ext import (

    CallbackQueryHandler,
    CommandHandler,
    ConversationHandler,
    MessageHandler,
    filters
)

import database

from handlers.admin_handlers import admin_generate_referral, show_referral_tree
from handlers.file_handlers import (
    handle_files,
    handle_reply,  # Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡
    handle_callback
)
from handlers.user_handlers import (
    FULL_NAME,
    PHONE,
    cancel_registration,
    get_full_name,
    get_phone,
    handle_active_orders,
    handle_archive,
    show_archive,
    start, generate_user_referral, handle_gift_request, show_direct_invites
)
import logging
from dotenv import load_dotenv
import os
from handlers.admin_handlers import admin_generate_referral
from models import Base, engine

Base.metadata.drop_all(engine)
Base.metadata.create_all(engine)

load_dotenv()
ADMINS = [2138687434]  # Ø¢ÛŒØ¯ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
DB_CONFIG = {
    'host': os.getenv('DB_HOST'),
    'user': os.getenv('DB_USER'),
    'password': os.getenv('DB_PASSWORD'),
    'database': os.getenv('DB_NAME'),
    'charset': 'utf8mb4'
}
# Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ main.py
import logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.DEBUG
)

# ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ
logging.getLogger("telegram").setLevel(logging.WARNING)
logging.getLogger("httpx").setLevel(logging.WARNING)
logging.getLogger("apscheduler").setLevel(logging.WARNING)
logging.getLogger("asyncio").setLevel(logging.WARNING)
logging.getLogger("httpcore").setLevel(logging.WARNING)





TOKEN = "7943645778:AAEXYzDKUc2D7mWaTcLrSkH4AjlJvVq7PaU"




def main():
    # Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù†Ø¯
    Base.metadata.create_all(bind=engine)


    app = TgApplication.builder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            FULL_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_full_name)],
            PHONE: [MessageHandler(filters.CONTACT | filters.TEXT & ~filters.COMMAND, get_phone)]
        },
        fallbacks=[CommandHandler("cancel", cancel_registration)],
    )

    app.add_handler(conv_handler)
    app.add_handler(MessageHandler(filters.Document.ALL, handle_files))
    app.add_handler(MessageHandler(filters.TEXT & filters.REPLY, handle_reply))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.Regex("ğŸ“‚ Ø¢Ø±Ø´ÛŒÙˆ"), show_archive))
    app.add_handler(MessageHandler(filters.Regex("^(ğŸ•’ Ù‡ÙØªÙ‡ Ø§Ø®ÛŒØ±|ğŸ“… Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±|ğŸ“‚ Ú©Ù„ Ø¢Ø±Ø´ÛŒÙˆ)$"),handle_archive))
    app.add_handler(MessageHandler(
        filters.Regex(r"^ğŸ”„ Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…(\(\d+\))?$"),  # Ù‚Ø¨ÙˆÙ„ Ù‡Ø± Ø¯Ùˆ ÙØ±Ù…Øª Ø¨Ø§ Ùˆ Ø¨Ø¯ÙˆÙ† Ø¹Ø¯Ø¯
        handle_active_orders
    ))
    # ØªØºÛŒÛŒØ± Ù‚Ø³Ù…Øª Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø±
    app.add_handler(MessageHandler(filters.Regex("ğŸ”— ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯"), admin_generate_referral))
    app.add_handler(CallbackQueryHandler(handle_callback))  # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø±
    # Ø¨Ù‡ Ù„ÛŒØ³Øª handlers Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:

    # Ø¯Ø± Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§:
    app.add_handler(
        MessageHandler(
            filters.Regex(r"^ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡$"),  # Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø¨Ø§Ø´Ø¯
            generate_user_referral
        )
    )
    app.add_handler(MessageHandler(filters.Regex("ğŸŒ³ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®Øª Ø¯Ø¹ÙˆØª"), show_referral_tree))
    app.add_handler(MessageHandler(filters.Regex("^ğŸ‘¥ Ù…Ø¯Ø¹ÙˆÛŒÙ† Ù…Ù†$"), show_direct_invites))
    # Ø¯Ø± ØªØ§Ø¨Ø¹ main ÛŒØ§ Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯:
    app.add_handler(
        CommandHandler(
            "gen_ref",
            admin_generate_referral,
            filters=filters.User(user_id=ADMINS)  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù„ÛŒØ³Øª ADMINS
        )
    )

    app.run_polling()


#
if __name__ == "__main__":
    main()

==================================================
# ÙØ§ÛŒÙ„: models.py
==================================================

from datetime import datetime
from sqlalchemy import ForeignKey, Column, Integer, String, DateTime, Boolean
from sqlalchemy.orm import relationship
from sqlalchemy import (
    create_engine,
    Column,
    Integer,
    String,
    Boolean,
    DateTime,
    ForeignKey,
    DECIMAL,
    Text,
    Index
)
from sqlalchemy.orm import declarative_base, relationship, sessionmaker
from sqlalchemy.sql import func
from config import Config

Base = declarative_base()


class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    full_name = Column(String(255), nullable=False)
    phone = Column(String(20), unique=True, nullable=False)
    inviter_id = Column(Integer, ForeignKey('users.id'))
    remaining_invites = Column(Integer, default=1)
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    is_admin = Column(Boolean, default=False)
    remaining_invites = Column(Integer, default=5)  # Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
    total_earned = Column(DECIMAL(10,2), default=0.00)  # Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ø² Ø±ÙØ±Ø§Ù„

    # Relationships
    inviter = relationship("User", remote_side=[id], back_populates="invitees")
    invitees = relationship("User", back_populates="inviter")
    files = relationship("File", back_populates="user")
    referrals = relationship("Referral", back_populates="referrer")
    invited_users = relationship("InvitedUser", foreign_keys="[InvitedUser.referrer_id]", back_populates="referrer")
    wallet = relationship("Wallet", uselist=False, back_populates="user")
    referrals = relationship("Referral", back_populates="referrer")


class File(Base):
    __tablename__ = 'files'

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    file_name = Column(String(255), nullable=False)
    mime_type = Column(String(100))
    file_id = Column(String(255), unique=True, nullable=False)
    file_unique_id = Column(String(255))
    created_at = Column(DateTime, server_default=func.now())
    quantity = Column(Integer, default=1)
    description = Column(Text)
    status = Column(String(50), default='Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…')
    notes = Column(Text)

    user = relationship("User", back_populates="files")


class Referral(Base):
    __tablename__ = 'referrals'

    id = Column(Integer, primary_key=True)
    referrer_id = Column(Integer, ForeignKey('users.id'))
    referral_code = Column(String(20), unique=True)
    created_at = Column(DateTime, default=datetime.now)
    expires_at = Column(DateTime)
    max_uses = Column(Integer, default=1)  # ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡
    used_count = Column(Integer, default=0)  # ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡
    is_active = Column(Boolean, default=True)
    is_admin_code = Column(Boolean, default=False)  # Ú©Ø¯ Ø§Ø¯Ù…ÛŒÙ†/Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ
    referrer = relationship("User", back_populates="referrals")



class InvitedUser(Base):
    __tablename__ = 'invited_users'

    referrer_id = Column(Integer, ForeignKey('users.id'), primary_key=True)
    invited_user_id = Column(Integer, ForeignKey('users.id'), primary_key=True)
    invited_full_name = Column(String(255), nullable=False)
    invited_phone = Column(String(20), nullable=False)
    invited_at = Column(DateTime, server_default=func.now())

    referrer = relationship(
        "User",
        foreign_keys=[referrer_id],
        back_populates="invited_users"
    )

    user = relationship(
        "User",
        foreign_keys=[invited_user_id]
    )


class Wallet(Base):
    __tablename__ = 'wallets'

    user_id = Column(Integer, ForeignKey('users.id'), primary_key=True)
    balance = Column(DECIMAL(10, 2), default=0.00)
    discount = Column(DECIMAL(10, 2), default=0.00)

    user = relationship("User", back_populates="wallet")


# Indexes

Index('ix_referrals_code', Referral.referral_code)
Index('ix_files_created_at', File.created_at)
Index('ix_referrals_expires', Referral.expires_at)

# Database engine configuration
engine = create_engine(
    f"mysql+pymysql://{Config.DB_USER}:{Config.DB_PASS}@{Config.DB_HOST}:{Config.DB_PORT}/{Config.DB_NAME}",
    pool_size=20,
    max_overflow=10,
    pool_pre_ping=True,
    pool_recycle=3600,
    connect_args={
        "connect_timeout": 15,
        "read_timeout": 30,
        "write_timeout": 30
    }
)

SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine
)


def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


# Create tables
if __name__ == "__main__":
    Base.metadata.create_all(bind=engine)

==================================================
# ÙØ§ÛŒÙ„: utils.py
==================================================

# ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯: utils.py
def generate_referral_link(bot_username: str, code: str) -> str:
    return f"https://t.me/{bot_username}?start=ref_{code}"

==================================================
# ÙØ§ÛŒÙ„: handlers\admin_handlers.py
==================================================

from telegram import Update
from telegram.ext import ContextTypes
from database import is_admin, ADMIN_ID
from models import SessionLocal, Referral, User
from sqlalchemy.exc import IntegrityError
from sqlalchemy.orm import aliased
from datetime import datetime, timedelta
import secrets
import string
import logging

logger = logging.getLogger(__name__)
from sqlalchemy.orm import Session
from telegram import Update
from telegram.ext import ContextTypes
from models import SessionLocal, Referral
from config import Config
import secrets
import string
from datetime import datetime, timedelta

# Ø¯Ø± handlers/admin_handlers.py
from utils import generate_referral_link

from datetime import datetime
import secrets
from sqlalchemy.exc import IntegrityError


async def admin_generate_referral(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        with SessionLocal() as db:
            # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ² Ø§Ø¯Ù…ÛŒÙ†
            admin_user = db.query(User).get(user.id)
            if not admin_user or not admin_user.is_admin:
                await update.message.reply_text("âŒ Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²!")
                return

            # ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ ÛŒÚ©ØªØ§
            code = None
            attempts = 0
            while not code and attempts < 5:
                try:
                    code = f"ADMIN_{secrets.token_urlsafe(8)}"
                    new_ref = Referral(
                        referrer_id=user.id,
                        referral_code=code,
                        expires_at=datetime(2100, 1, 1),
                        max_uses=999999,
                        is_admin_code=True
                    )
                    db.add(new_ref)
                    db.commit()
                except IntegrityError:
                    db.rollback()
                    code = None
                    attempts += 1

            if not code:
                await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯!")
                return

            # Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú©
            bot = await context.bot.get_me()
            invite_link = f"https://t.me/{bot.username}?start=ref_{code}"

            await update.message.reply_text(
                f"ğŸ”— Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø§Ø¯Ù…ÛŒÙ†:\n{invite_link}\n"
                "â³ Ø§Ø¹ØªØ¨Ø§Ø±: Ø¯Ø§Ø¦Ù…ÛŒ\n"
                "ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡: Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯"
            )

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú©: {str(e)}", exc_info=True)
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú©!")


async def show_users_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_ID:
        return

    users = get_all_users()
    response = "ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:\n\n"
    for user in users:
        response += f"ğŸ†” {user[0]} - ğŸ“ {user[2]}\n"

    await update.message.reply_text(response)


from sqlalchemy.orm import aliased


def build_tree(root_id: int, db: Session, level: int = 0):
    """Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ØªÙ† Ø¨Ø§Ø²Ú¯Ø´Øª Ù…ÛŒâ€ŒØ¯Ù‡Ø¯"""
    try:
        Inviter = aliased(User)
        Invitee = aliased(User)

        # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø·Ø­ ÙØ¹Ù„ÛŒ
        nodes = db.query(
            Inviter.id.label("inviter_id"),
            Inviter.full_name.label("inviter_name"),
            Invitee.id.label("invitee_id"),
            Invitee.full_name.label("invitee_name")
        ).join(
            Invitee, Invitee.inviter_id == Inviter.id
        ).filter(
            Inviter.id == root_id
        ).all()

        tree_str = ""
        prefix = "â”‚   " * (level - 1) + "â”œâ”€â”€ " if level > 0 else ""

        for node in nodes:
            # Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø¹ÙˆØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ ÙØ¹Ù„ÛŒ
            tree_str += f"{prefix}ğŸ‘¤ {node.inviter_name}\n"

            # Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ø±Ø§ÛŒ ÙØ±Ø²Ù†Ø¯Ø§Ù†
            tree_str += build_tree(node.invitee_id, db, level + 1)

        return tree_str

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ø¯Ø±Ø®Øª: {str(e)}")
        return "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®ØªØ§Ø±"


# Ø¯Ø± handlers/admin_handlers.py
async def show_referral_tree(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        with SessionLocal() as db:
            # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¯Ù…ÛŒÙ† Ø±ÛŒØ´Ù‡
            root_admin = db.query(User).filter(
                User.id == Config.ADMINS[0]
            ).first()

            if not root_admin:
                await update.message.reply_text("âŒ Ø§Ø¯Ù…ÛŒÙ† Ø§ØµÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!")
                return

            tree = build_tree(root_admin.id, db)
            await update.message.reply_text(f"ğŸŒ³ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§:\n{tree}")

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§: {str(e)}")
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®Øª")


==================================================
# ÙØ§ÛŒÙ„: handlers\file_handlers.py
==================================================

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from datetime import datetime
import database
import keyboards
from keyboards import get_qty_keyboard
import logging

logger = logging.getLogger(__name__)


async def handle_files(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    if not database.get_user(user.id):
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯!")
        return

    doc = update.message.document
    file_data = (
        user.id,
        doc.file_name,
        doc.mime_type,
        doc.file_id,
        doc.file_unique_id,
        datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        1,
        "ÙØ§Ù‚Ø¯ ØªÙˆØ¶ÛŒØ­Ø§Øª",
        "Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…",
        ""
    )

    if not database.add_file(file_data):
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„!")
        return

    # Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    keyboard = [
        [
            InlineKeyboardButton("ØªØ¹Ø¯Ø§Ø¯ ğŸ§®", callback_data="edit_qty")
        ],
        [
            InlineKeyboardButton("Ø§Ù†ØµØ±Ø§Ù âŒ", callback_data="cancel_file")
        ]
    ]

    await update.message.reply_document(
        document=doc.file_id,
        caption=f"""â° Ø²Ù…Ø§Ù† ØªØ­ÙˆÛŒÙ„: ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡
ğŸ§® ØªØ¹Ø¯Ø§Ø¯: 1
ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª: ÙØ§Ù‚Ø¯ ØªÙˆØ¶ÛŒØ­Ø§Øª
ğŸ“Œ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† ØªÙˆØ¶ÛŒØ­Ø§ØªØŒ Ø±ÙˆÛŒ Ù¾ÛŒØ§Ù… Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ú©Ù†ÛŒØ¯""",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    message = query.message

    try:
        logger.debug(f"Callback data received: {data}")

        # Ø¯Ø±ÛŒØ§ÙØª file_id Ø§Ø² Ù¾ÛŒØ§Ù… Ø§ØµÙ„ÛŒ
        if not message.document:
            logger.error("No document found in the message!")
            return

        file_id = message.document.file_id
        logger.info(f"Processing file ID: {file_id}")

        # Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†ÙˆØ§Ø¹ callback
        if data == "edit_qty":
            current_qty = database.get_file_quantity(file_id)
            await message.edit_reply_markup(
                reply_markup=keyboards.get_qty_keyboard(current_qty)
            )

        elif data in ("qty_up", "qty_down"):
            current_qty = int(message.reply_markup.inline_keyboard[0][1].text)

            if data == "qty_up":
                new_qty = current_qty + 1
            else:
                new_qty = max(1, current_qty - 1)

            # Ø¢Ù¾Ø¯ÛŒØª Ú©ÛŒØ¨ÙˆØ±Ø¯
            await message.edit_reply_markup(
                reply_markup=keyboards.get_qty_keyboard(new_qty)
            )

        elif data == "qty_confirm":
            final_qty = int(message.reply_markup.inline_keyboard[0][1].text)
            if database.update_file_quantity(file_id, final_qty):
                # Ø¢Ù¾Ø¯ÛŒØª Ú©Ù¾Ø´Ù†
                new_caption = message.caption.split('\n')
                new_caption[1] = f"ğŸ§® ØªØ¹Ø¯Ø§Ø¯: {final_qty}"
                await message.edit_caption(
                    caption="\n".join(new_caption),
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("ØªØ¹Ø¯Ø§Ø¯ ğŸ§®", callback_data="edit_qty")],
                        [InlineKeyboardButton("Ø§Ù†ØµØ±Ø§Ù âŒ", callback_data="cancel_file")]
                    ])
                )
            else:
                await query.answer("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯!")

        elif data == "qty_cancel":
            await message.edit_reply_markup(
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("ØªØ¹Ø¯Ø§Ø¯ ğŸ§®", callback_data="edit_qty")],
                    [InlineKeyboardButton("Ø§Ù†ØµØ±Ø§Ù âŒ", callback_data="cancel_file")]
                ])
            )

        elif data == "cancel_file":
            await message.delete()
            database.delete_file(file_id)  # Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ø¨Ø¹ delete_file Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³

    except Exception as e:
        logger.error(f"Error in callback handler: {str(e)}", exc_info=True)
        await query.answer("âš ï¸ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø±Ø® Ø¯Ø§Ø¯!")


from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
import database

async def handle_reply(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø´Ø¯Ù‡"""
    if not update.message.reply_to_message.document:
        return

    user = update.effective_user
    file_id = update.message.reply_to_message.document.file_id
    description = update.message.text.strip()

    # Ø¢Ù¾Ø¯ÛŒØª ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    if database.update_file_description(file_id, description):
        # Ø¢Ù¾Ø¯ÛŒØª Ú©Ù¾Ø´Ù† Ù¾ÛŒØ§Ù…
        new_caption = f"""
â° Ø²Ù…Ø§Ù† ØªØ­ÙˆÛŒÙ„: ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡
ğŸ§® ØªØ¹Ø¯Ø§Ø¯: {database.get_file_quantity(file_id)}
ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª: {description}
        """.strip()

        keyboard = [
            [InlineKeyboardButton("ØªØ¹Ø¯Ø§Ø¯ ğŸ§®", callback_data="edit_qty")],
            [InlineKeyboardButton("Ø§Ù†ØµØ±Ø§Ù âŒ", callback_data="cancel_file")]
        ]

        await update.message.reply_to_message.edit_caption(
            caption=new_caption,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        await update.message.reply_text("âœ… ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!")
    else:
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙˆØ¶ÛŒØ­Ø§Øª!")


==================================================
# ÙØ§ÛŒÙ„: handlers\user_handlers.py
==================================================

from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import (
    ContextTypes,
    ConversationHandler,
    CommandHandler,
    MessageHandler,
    filters
)
from keyboards import customer_kb
import database
from keyboards import admin_kb, customer_kb
from models import SessionLocal, User, Referral, Wallet
from sqlalchemy.exc import SQLAlchemyError
from database import add_user, validate_referral, is_admin
from config import Config
import logging
logger = logging.getLogger(__name__)

# ØªÙ†Ø¸ÛŒÙ… Ø³Ø·Ø­ Ù„Ø§Ú¯
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.DEBUG
)
ADMIN_ID = 2138687434
FULL_NAME, PHONE = range(2)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        with SessionLocal() as db:
            # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÙˆÙ„: Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù„ÛŒØ³Øª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ÛŒ config Ø§Ø³ØªØŸ
            if user.id in Config.ADMINS:
                db_admin = db.query(User).get(user.id)

                if not db_admin:
                    # Ø§ÛŒØ¬Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ† Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                    admin_data = {
                        'id': user.id,
                        'full_name': user.full_name or "Ø§Ø¯Ù…ÛŒÙ† Ø³ÛŒØ³ØªÙ…",
                        'phone': "Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡",
                        'is_admin': True
                    }

                    if add_user(admin_data):
                        await update.message.reply_text(
                            "ğŸ‘‘ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯!",
                            reply_markup=admin_kb
                        )
                    else:
                        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ø¯Ù…ÛŒÙ†")
                    return ConversationHandler.END
                else:
                    # Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¯Ù…ÛŒÙ† Ø§Ú¯Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡
                    if db_admin.full_name != user.full_name:
                        db_admin.full_name = user.full_name
                        db.commit()

                    await update.message.reply_text(
                        "ğŸ‘‘ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯!",
                        reply_markup=admin_kb
                    )
                    return ConversationHandler.END

            # Ù…Ù†Ø·Ù‚ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ
            db_user = db.query(User).get(user.id)

            if db_user:
                await update.message.reply_text(
                    "âœ… Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!",
                    reply_markup=customer_kb
                )
                return ConversationHandler.END

            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø¯ Ø¯Ø¹ÙˆØª Ø§Ø² Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§
            referral_code = None
            if context.args:
                first_arg = context.args[0]
                if first_arg.startswith("ref_"):
                    referral_code = first_arg[4:]

            if not referral_code:
                await update.message.reply_text("ğŸ”’ Ø¯Ø³ØªØ±Ø³ÛŒ ÙÙ‚Ø· Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù…Ù…Ú©Ù† Ø§Ø³Øª!")
                return ConversationHandler.END

            # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ø¯Ø¹ÙˆØª
            valid, referrer_id = validate_referral(db, referral_code)
            if not valid:
                await update.message.reply_text(f"âŒ {referrer_id}")
                return ConversationHandler.END

            context.user_data["referral_code"] = referral_code
            context.user_data["referrer_id"] = referrer_id

            await update.message.reply_text("ğŸ‘¤ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
            return FULL_NAME

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ: {str(e)}", exc_info=True)
        await update.message.reply_text("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ! Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
        return ConversationHandler.END


async def get_full_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["full_name"] = update.message.text
    await update.message.reply_text(
        "ğŸ“± Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ ğŸ“²", request_contact=True)]],
            resize_keyboard=True
        )
    )
    return PHONE


# ÙØ§ÛŒÙ„: handlers/user_handlers.py
async def get_phone(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        with SessionLocal() as db:
            # Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³
            if update.message.contact:
                phone = update.message.contact.phone_number
            else:
                phone = update.message.text.strip()

            # Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³
            if not phone.startswith('+'):
                phone = f"+98{phone[-10:]}"  # ÙØ±Ù…Øª Ø§ÛŒØ±Ø§Ù†

            # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±
            user_data = {
                'id': user.id,
                'full_name': context.user_data["full_name"],
                'phone': phone,
                'inviter_id': context.user_data["referrer_id"],
                'is_admin': False
            }

            # Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            if add_user(user_data):
                # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø¯ Ø±ÙØ±Ø§Ù„
                referral = db.query(Referral).filter(
                    Referral.referral_code == context.user_data["referral_code"]
                ).first()

                if referral:
                    referral.used_by = user.id
                    db.commit()

                # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±ÛŒ
                await update.message.reply_text(
                    "âœ… Ø«Ø¨Øª Ù†Ø§Ù… Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!\n"
                    "Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:",
                    reply_markup=customer_kb  # Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±ÛŒ
                )

                # Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯Ø¹ÙˆØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡
                if referral and not referral.is_admin:
                    inviter = db.query(User).get(referral.referrer_id)
                    if inviter:
                        inviter.remaining_invites -= 1
                        db.commit()
            else:
                await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª!")

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…: {str(e)}", exc_info=True)
        await update.message.reply_text("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ! Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

    finally:
        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
        context.user_data.clear()
        return ConversationHandler.END


async def get_full_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["full_name"] = update.message.text
    await update.message.reply_text(
        "ğŸ“± Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ ğŸ“²", request_contact=True)]],
            resize_keyboard=True
        )
    )
    return PHONE


async def get_phone(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        with SessionLocal() as db:
            # Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³
            phone = (
                update.message.contact.phone_number
                if update.message.contact
                else update.message.text.strip()
            )

            # ÙØ±Ù…Øªâ€ŒØ¯Ù‡ÛŒ Ø´Ù…Ø§Ø±Ù‡ Ø§ÛŒØ±Ø§Ù†
            if not phone.startswith('+'):
                phone = f"+98{phone[-10:]}"  # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ÙØ±Ù…Øª Ø¨ÛŒÙ†â€ŒØ§Ù„Ù…Ù„Ù„ÛŒ

            # Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ø±ÙØ±Ø§Ù„ Ø§Ø² context
            referral_code = context.user_data.get("referral_code")
            referrer_id = None

            # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ø±ÙØ±Ø§Ù„
            if referral_code:
                valid, result = validate_referral(db, referral_code)
                if valid:
                    referrer_id = result
                else:
                    await update.message.reply_text(f"âŒ {result}")
                    return ConversationHandler.END

            # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
            user_data = {
                'id': user.id,
                'full_name': context.user_data["full_name"],
                'phone': phone,
                'inviter_id': referrer_id,
                'is_admin': False,
                'remaining_invites': 5  # Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            }

            if add_user(user_data):
                # Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯Ø¹ÙˆØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡
                if referrer_id:
                    referrer = db.query(User).get(referrer_id)
                    if referrer and not referrer.is_admin:
                        referrer.remaining_invites -= 1
                        db.commit()

                # Ø§Ø±Ø³Ø§Ù„ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±ÛŒ
                await update.message.reply_text(
                    "âœ… Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚! Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:",
                    reply_markup=customer_kb
                )
            else:
                await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª!")

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ: {str(e)}", exc_info=True)
        await update.message.reply_text("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ! Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

    finally:
        context.user_data.clear()
        return ConversationHandler.END


# ÙØ§ÛŒÙ„: handlers/user_handlers.py
async def cancel_registration(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_text("âŒ Ø«Ø¨Øª Ù†Ø§Ù… Ù„ØºÙˆ Ø´Ø¯.")
    return ConversationHandler.END


# Ø§ØµÙ„Ø§Ø­ Ø¨Ø®Ø´ Ù¾Ø§ÛŒØ§Ù†ÛŒ ÙØ§ÛŒÙ„
start_conversation = ConversationHandler(
    entry_points=[CommandHandler("start", start)],
    states={
        FULL_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_full_name)],
        PHONE: [MessageHandler(filters.CONTACT | filters.TEXT & ~filters.COMMAND, get_phone)]
    },
    fallbacks=[CommandHandler("cancel", cancel_registration)]
)




async def show_archive(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=archive_reply_kb
    )


async def handle_active_orders(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    active_orders = database.get_active_orders(user.id)

    if not active_orders:
        await update.message.reply_text("âœ… Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!")
        return

    response = "ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª ÙØ¹Ø§Ù„ Ø´Ù…Ø§:\n\n"
    for order in active_orders:
        response += f"""ğŸ”– Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order[0]}
ğŸ“ ÙØ§ÛŒÙ„: {order[2]}
ğŸ§® ØªØ¹Ø¯Ø§Ø¯: {order[7]}
â³ ÙˆØ¶Ø¹ÛŒØª: {order[9]}
â–â–â–â–â–â–â–\n"""

    await update.message.reply_text(response)




async def handle_archive(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    text = update.message.text

    days = None
    if text == "ğŸ•’ Ù‡ÙØªÙ‡ Ø§Ø®ÛŒØ±":
        days = 7
    elif text == "ğŸ“… Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±":
        days = 30

    files = database.get_files_by_user(user.id, days)

    if not files:
        await update.message.reply_text(
            "âŒ Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!",
            reply_markup=customer_kb
        )
        return

    for file in files:
        miladi_date = datetime.strptime(file[6], "%Y-%m-%d %H:%M:%S")
        shamsi_date = jdatetime.fromgregorian(datetime=miladi_date)

        caption = f"""
ğŸ“ Ù†Ø§Ù… ÙØ§ÛŒÙ„: {file[2]}
ğŸ“… ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„: 
  Ø´Ù…Ø³ÛŒ: {shamsi_date.strftime("%Y/%m/%d")}
  Ù…ÛŒÙ„Ø§Ø¯ÛŒ: {miladi_date.strftime("%Y/%m/%d")}
ğŸ§® ØªØ¹Ø¯Ø§Ø¯: {file[7]}
ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª: {file[8]}
        """.strip()

        await context.bot.send_document(
            chat_id=user.id,
            document=file[4],
            caption=caption
        )

    await update.message.reply_text(
        "âœ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù†Ø¯!",
        reply_markup=customer_kb
    )


async def generate_user_referral(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        with SessionLocal() as db:
            # Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
            db_user = db.query(User).get(user.id)
            if db_user.remaining_invites <= 0:
                await update.message.reply_text("âŒ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡!")
                return

            # ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ ÛŒÚ©ØªØ§
            code = f"USER_{secrets.token_urlsafe(8)}"
            while db.query(Referral).filter_by(referral_code=code).first():
                code = f"USER_{secrets.token_urlsafe(8)}"

            # Ø§ÛŒØ¬Ø§Ø¯ Ø±ÙØ±Ø§Ù„
            new_ref = Referral(
                referrer_id=user.id,
                referral_code=code,
                expires_at=datetime.now() + timedelta(days=30),
                max_uses=1,  # ØªÚ© Ø¨Ø§Ø± Ù…ØµØ±Ù
                is_admin_code=False
            )

            db.add(new_ref)
            db_user.remaining_invites -= 1
            db.commit()

            # Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú©
            bot = await context.bot.get_me()
            invite_link = f"https://t.me/{bot.username}?start=ref_{code}"

            await update.message.reply_text(
                f"ğŸ”— Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù…Ø§:\n{invite_link}\n"
                f"ğŸ“ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {db_user.remaining_invites}\n"
                "âš ï¸ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!"
            )

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§: {str(e)}")
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú©!")


async def handle_gift_request(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        with SessionLocal() as db:
            # Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ· Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡
            user_data = db.query(User).get(user.id)

            # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            if not user_data:
                await update.message.reply_text("âŒ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯!")
                return

            # Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ· Ù‡Ø¯ÛŒÙ‡
            if meets_gift_conditions(db, user.id):
                # Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¹ØªØ¨Ø§Ø± Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„
                wallet = db.query(Wallet).get(user.id)
                if wallet:
                    wallet.discount += 100  # Ø§ÙØ²ÙˆØ¯Ù† 100 ÙˆØ§Ø­Ø¯ Ø§Ø¹ØªØ¨Ø§Ø±
                    db.commit()
                    await update.message.reply_text("ğŸ‰ 100 ÙˆØ§Ø­Ø¯ Ø§Ø¹ØªØ¨Ø§Ø± Ù‡Ø¯ÛŒÙ‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯!")
                else:
                    await update.message.reply_text("âŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯!")
            else:
                await update.message.reply_text("âš ï¸ Ø´Ø±Ø§ÛŒØ· Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡ Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯!")

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ø¯ÛŒÙ‡: {str(e)}", exc_info=True)
        await update.message.reply_text("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ! Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")


# user_handlers.py
# ÙØ§ÛŒÙ„ handlers/user_handlers.py
async def show_direct_invites(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        invites = database.get_direct_invites(user.id)

        if not invites:
            await update.message.reply_text("â„¹ï¸ Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø±Ø§ Ø¯Ø¹ÙˆØª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!")
            return

        response = "ğŸ“‹ Ù„ÛŒØ³Øª Ù…Ø¯Ø¹ÙˆÛŒÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ø´Ù…Ø§:\n\n"
        for idx, invite in enumerate(invites, 1):
            response += (
                f"{idx}. ğŸ‘¤ {invite['invited_full_name']}\n"
                f"   ğŸ“ {invite['invited_phone']}\n"
                f"   ğŸ“… {invite['invited_date']}\n\n"
            )

        await update.message.reply_text(response)

    except Exception as e:
        logging.error(f"Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯Ø¹ÙˆÛŒÙ†: {str(e)}", exc_info=True)
        await update.message.reply_text("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ!")

